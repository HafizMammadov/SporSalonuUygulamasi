@model SporSalonuUygulamasi.Models.Appointment

@{
    ViewData["Title"] = "Randevu Al";
}

<div class="container mt-5">

    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">

            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0 text-center">
                        <i class="bi bi-calendar-plus me-2"></i>
                        Randevu Oluştur
                    </h3>
                </div>

                <div class="card-body p-4 p-md-5">

                    <form asp-action="Create" id="appointmentForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- Salon Seçimi -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Spor Salonu</label>
                            <select id="GymId" class="form-select">
                                <option value="">-- Bir Salon Seçiniz --</option>
                                @foreach (var gym in ViewBag.GymId as SelectList)
                                {
                                    <option value="@gym.Value">@gym.Text</option>
                                }
                            </select>
                        </div>

                        <!-- Eğitmen Seçimi -->
                        <div class="mb-4">
                            <label asp-for="TrainerId" class="form-label fw-bold"></label>
                            <select asp-for="TrainerId" class="form-select" disabled>
                                <option value="">-- Önce Salon Seçiniz --</option>
                            </select>
                            <span asp-validation-for="TrainerId" class="text-danger"></span>
                        </div>

                        <!-- Tarih Seçimi -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Randevu Tarihi</label>
                            <input type="date"
                                   id="datePicker"
                                   class="form-control"
                                   min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        </div>

                        <!-- Saat Seçimi -->
                        <div id="timeSlotsContainer" class="mb-4" style="display:none;">
                            <label class="form-label fw-bold">Müsait Saatler</label>

                            <div id="slots" class="d-flex flex-wrap gap-2"></div>

                            <div id="noSlotsMessage" class="alert alert-warning mt-3" style="display:none;">
                                <i class="bi bi-exclamation-circle me-1"></i>
                                Seçilen tarihte bu eğitmen için uygun saat bulunmamaktadır.
                            </div>
                        </div>

                        <!-- Gizli Tarih Alanı -->
                        <input type="hidden" asp-for="AppointmentDate" />

                        <!-- Butonlar -->
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-success btn-lg" id="btnSubmit" disabled>
                                <i class="bi bi-check-lg me-1"></i>
                                Randevuyu Onayla
                            </button>

                            <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">
                                İptal
                            </a>
                        </div>

                    </form>

                </div>
            </div>

        </div>
    </div>

</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {

            var gymSelect = $('#GymId');
            var trainerSelect = $('#TrainerId');
            var datePicker = $('#datePicker');
            var slotsContainer = $('#timeSlotsContainer');
            var slotsDiv = $('#slots');
            var noSlotsMsg = $('#noSlotsMessage');
            var hiddenDateInput = $('#AppointmentDate');
            var submitBtn = $('#btnSubmit');

            function resetTimeSlots() {
                slotsDiv.empty();
                slotsContainer.hide();
                noSlotsMsg.hide();
                hiddenDateInput.val('');
                submitBtn.prop('disabled', true);
            }

            // Salon değiştiğinde eğitmenleri getir
            gymSelect.change(function () {
                var gymId = $(this).val();

                trainerSelect
                    .empty()
                    .append('<option value="">-- Eğitmen Seçiniz --</option>')
                    .prop('disabled', true);

                resetTimeSlots();

                if (gymId) {
                    $.getJSON('/Appointment/GetTrainersByGym', { gymId: gymId }, function (data) {
                        $.each(data, function (i, trainer) {
                            trainerSelect.append(
                                '<option value="' + trainer.value + '">' + trainer.text + '</option>'
                            );
                        });
                        trainerSelect.prop('disabled', false);
                    });
                }
            });

            // Eğitmen veya tarih değiştiğinde saatleri getir
            function loadAvailableHours() {
                var trainerId = trainerSelect.val();
                var date = datePicker.val();

                resetTimeSlots();

                if (trainerId && date) {
                    $.getJSON('/Appointment/GetAvailableHours',
                        { trainerId: trainerId, date: date },
                        function (times) {
                            slotsContainer.show();

                            if (times.length > 0) {
                                $.each(times, function (index, time) {
                                    var btn = $('<button type="button" class="btn btn-outline-primary">' + time + '</button>');

                                    btn.click(function () {
                                        $('.time-slot').removeClass('active btn-primary')
                                                       .addClass('btn-outline-primary');

                                        $(this).removeClass('btn-outline-primary')
                                               .addClass('btn-primary active');

                                        hiddenDateInput.val(date + 'T' + time);
                                        submitBtn.prop('disabled', false);
                                    });

                                    btn.addClass('time-slot');
                                    slotsDiv.append(btn);
                                });
                            } else {
                                noSlotsMsg.show();
                            }
                        });
                }
            }

            trainerSelect.change(loadAvailableHours);
            datePicker.change(loadAvailableHours);

        });
    </script>
}
